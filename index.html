<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.51">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/simple-3d-printer/logo.svg"><title>How 3d printer works? | Simply 3d printer</title><meta name="description" content="Find out how 3d printer works by writing a firmware">
    <link rel="modulepreload" href="/simple-3d-printer/assets/app.3e33cde9.js"><link rel="modulepreload" href="/simple-3d-printer/assets/index.html.eec06f06.js"><link rel="modulepreload" href="/simple-3d-printer/assets/index.html.8e79c826.js"><link rel="prefetch" href="/simple-3d-printer/assets/index.html.fc811998.js"><link rel="prefetch" href="/simple-3d-printer/assets/404.html.d2dc3323.js"><link rel="prefetch" href="/simple-3d-printer/assets/index.html.aad130c2.js"><link rel="prefetch" href="/simple-3d-printer/assets/404.html.88d7534d.js">
    <link rel="stylesheet" href="/simple-3d-printer/assets/style.a0733f6a.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a aria-current="page" href="/simple-3d-printer/" class="router-link-active router-link-exact-active"><!----><span class="site-name can-hide">Simply 3d printer</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a aria-current="page" href="/simple-3d-printer/" class="router-link-active router-link-exact-active" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/simple-3d-printer/zh/" class="" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a aria-current="page" href="/simple-3d-printer/" class="router-link-active router-link-exact-active" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/simple-3d-printer/zh/" class="" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">How 3d printer works? <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/simple-3d-printer/#setup" class="router-link-active router-link-exact-active sidebar-item" aria-label="Setup"><!--[--><!--]--> Setup <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/simple-3d-printer/#parse-gcode" class="router-link-active router-link-exact-active sidebar-item" aria-label="Parse gcode"><!--[--><!--]--> Parse gcode <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/simple-3d-printer/#sd-card" class="router-link-active router-link-exact-active sidebar-item" aria-label="SD card"><!--[--><!--]--> SD card <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/simple-3d-printer/#temperature-control" class="router-link-active router-link-exact-active sidebar-item" aria-label="Temperature control"><!--[--><!--]--> Temperature control <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/simple-3d-printer/#motor-control" class="router-link-active router-link-exact-active sidebar-item" aria-label="Motor control"><!--[--><!--]--> Motor control <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/simple-3d-printer/#endstop" class="router-link-active router-link-exact-active sidebar-item" aria-label="Endstop"><!--[--><!--]--> Endstop <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/simple-3d-printer/#motion-control" class="router-link-active router-link-exact-active sidebar-item" aria-label="Motion control"><!--[--><!--]--> Motion control <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/simple-3d-printer/#speed-control" class="router-link-active router-link-exact-active sidebar-item" aria-label="Speed control"><!--[--><!--]--> Speed control <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><p><img src="/simple-3d-printer/assets/image-20220309193844931.1144eef8.png" alt="image-20220309193844931"></p><h1 id="how-3d-printer-works" tabindex="-1"><a class="header-anchor" href="#how-3d-printer-works" aria-hidden="true">#</a> How 3d printer works?</h1><p>​ Hello, I am Arno. Today we are going to find out how 3d printer works by writing a firmware. <a href="https://github.com/arnosolo/simple_3d_printer" target="_blank" rel="noopener noreferrer">code link<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="setup" tabindex="-1"><a class="header-anchor" href="#setup" aria-hidden="true">#</a> Setup</h3><h4 id="hardware" tabindex="-1"><a class="header-anchor" href="#hardware" aria-hidden="true">#</a> Hardware</h4><p>​ Firstly, we need a 3D printer that is already able to print. So if we encounter any issue while we are writing firmware, we know it&#39;s not a hardware problem. You can buy a machine directly, but I would recommend you assemble one by yourself. In this way, If there is a mechanical problem, you can handle it by yourself since you already familiar with the mechanical structure and also because you have schematic to check which these commercial companies probably not willing to provide. Here are hardware I choosen.</p><ul><li><p>Mother board</p><ul><li><p><a href="https://github.com/makerbase-mks/MKS-GEN_L/tree/master/hardware/MKS%20Gen_L%20V2.1_001" target="_blank" rel="noopener noreferrer">MKS GENL V2.1<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>which controlled by a <a href="https://ww1.microchip.com/downloads/en/devicedoc/atmel-2549-8-bit-avr-microcontroller-atmega640-1280-1281-2560-2561_datasheet.pdf" target="_blank" rel="noopener noreferrer">AVR mega2560<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li></ul></li><li><p>Stepper driver</p><ul><li>X TMC2008</li><li>Y TMC2008</li><li>Z A4988</li><li>E TMC2225</li></ul></li><li><p>Mechanical structure</p><ul><li><p>Big fish i3</p><img title="" src="/simple-3d-printer/assets/big-fish-i3.a830baac.jpeg" alt="big-fish-i3" width="254"></li></ul></li></ul><h4 id="software" tabindex="-1"><a class="header-anchor" href="#software" aria-hidden="true">#</a> Software</h4><p>In this step, we want make sure the MCU can run our code.</p><ol><li><p>Download <a href="https://code.visualstudio.com/" target="_blank" rel="noopener noreferrer">vscode<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p>Install addon <code>platformio</code></p></li><li><p>Open platformio tag, create new project, choose Board as mega2560, choose Framework as Arduino.</p></li><li><p>Now we write some test code in <code>src/main.cpp</code></p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// src/main.cpp</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Arduino.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Serial<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello from Mega2560.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>Connect 3D printing motherboard with compute, click the right arrow ➡ button at the bottom of <code>vscode</code>. Then <code>platformio</code> will compile and upload the test code above into 3D printing motherboard</p><p><img src="data:image/png;base64,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" alt="image-20220325104440980"></p></li><li><p>Open any Serial assistant you prefer, connect the motherboard, if you found <code>Hello from Mega2560.</code> is printed, then you are all set.</p></li></ol><h3 id="parse-gcode" tabindex="-1"><a class="header-anchor" href="#parse-gcode" aria-hidden="true">#</a> Parse gcode</h3><p>Gcode was generated by Slicer like <a href="https://ultimaker.com/software/ultimaker-cura" target="_blank" rel="noopener noreferrer">Cura<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> or <a href="https://www.prusa3d.com/page/prusaslicer_424/" target="_blank" rel="noopener noreferrer">Prusa<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>. It tells the printer where the hotend should go and what temperature should it maintain.</p><p><img src="/simple-3d-printer/assets/image-20220330051541011.76bc1d2f.png" alt="image-20220330051541011"></p><ul><li><p>Most used gcode</p><div class="language-gcode ext-gcode line-numbers-mode"><pre class="language-gcode"><code><span class="token keyword">G1</span> <span class="token property">F</span>200 <span class="token property">X</span>2 <span class="token property">Y</span>4 <span class="token comment">; move to (2,4,0) and set feedrate as 200mm/min, 99% gcodes looks like this</span>
<span class="token keyword">G28</span> <span class="token property">X</span>0 <span class="token property">Y</span>0 <span class="token comment">; move X/Y to min endstops</span>
<span class="token keyword">M104</span> <span class="token property">S</span>200 <span class="token comment">; set hotend temp as 200℃</span>
<span class="token keyword">M20</span> <span class="token comment">; List SD Card</span>
<span class="token keyword">M23</span> <span class="token comment">; Select SD file</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>check all gcodes in <a href="https://marlinfw.org/docs/gcode/G000-G001.html" target="_blank" rel="noopener noreferrer">online documents of Marlin<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li></ul><p>In this section, we should implement the <code>parse</code> function of <code>Gcode</code> class which is able to convert a gcode string like <code>G1 X2.4 Y5.6</code> into a <code>gcode object</code>.</p><ul><li><p><code>gcode object</code> example</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code>gcode<span class="token punctuation">.</span>cmdtype <span class="token operator">=</span> <span class="token char">&#39;G&#39;</span><span class="token punctuation">;</span>
gcode<span class="token punctuation">.</span>cmdnum <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
gcode<span class="token punctuation">.</span>X <span class="token operator">=</span> <span class="token number">2.4</span><span class="token punctuation">;</span>
gcode<span class="token punctuation">.</span>Y <span class="token operator">=</span> <span class="token number">5.6</span><span class="token punctuation">;</span>
gcode<span class="token punctuation">.</span>hasX <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
gcode<span class="token punctuation">.</span>hasY <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Notice that if you try to use &#39;\n&#39; to split string like me, you need be careful that some gcode string might end with &quot;\r\n&quot;</p></li></ul><h3 id="sd-card" tabindex="-1"><a class="header-anchor" href="#sd-card" aria-hidden="true">#</a> SD card</h3><p>In general, we need to configure SPI to use SD card. But we are using mega2560, we can use the <a href="https://github.com/arduino-libraries/SD" target="_blank" rel="noopener noreferrer">SD Library for Arduino<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>. The only thing we need to do is find which pin is the <code>CS</code> (chip select) pin in schematic and call <code>SD.begin(csPin)</code> function in <code>setup</code> function.</p><h3 id="temperature-control" tabindex="-1"><a class="header-anchor" href="#temperature-control" aria-hidden="true">#</a> Temperature control</h3><p>Call <code>hotend.update()</code> every 150ms, which will decide turn the heater on or off according to current temperature.</p><ul><li>150ms interval was implemented using timer(<code>Heater::init</code>)</li><li>Temperature control algorithm is PID(<code>Heater::calculatePid</code>)</li></ul><h3 id="motor-control" tabindex="-1"><a class="header-anchor" href="#motor-control" aria-hidden="true">#</a> Motor control</h3><p>In this section, we should figure out how to control stepper motor through a stepper motor driver like <code>A4988</code>.</p><h4 id="a4988" tabindex="-1"><a class="header-anchor" href="#a4988" aria-hidden="true">#</a> A4988</h4><p><img src="/simple-3d-printer/assets/image-20220312054743069.b7753809.png" alt="image-20220312054743069"></p><ol><li><p>VMOT</p><p>8V~35V DC, A 100uf capacitor needs to be placed between <code>VMOT</code> and <code>GND</code> to quickly respond to the motor&#39;s power demand. Beware, this is the only pin that connect high voltage, if you connect other pins with 24V DC, this module will <strong>burn in seconds</strong>.</p></li><li><p>1A 1B</p><p>Connect to coil 1 of the stepper motor</p></li><li><p>2A 2B</p><p>Connect to coil 2 of the stepper motor</p></li><li><p>VDD</p><p>MCU power</p></li><li><p>DIR</p><p>Connect to MCU, high and low each represent a different direction.</p></li><li><p>STEP</p><p>Each time this pin receives a pulse, <code>A4988</code> will dive the stepper motor advance one step. Normal stepper motor used in 3d printer takes 200 steps to complete a revolution, which means 200 pulses.</p></li><li><p>MS1 MS2 MS3</p><p>But in most conditions, to drive stepper motor advance one revolution, 3200 pulses should be feed into A4988. That&#39;s because one step is divided into 16 micro steps.</p><table><thead><tr><th>MS1</th><th>MS2</th><th>MS3</th><th>subdivision</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>0</td><td>1</td></tr><tr><td>1</td><td>0</td><td>0</td><td>2</td></tr><tr><td>0</td><td>1</td><td>0</td><td>4</td></tr><tr><td>1</td><td>1</td><td>0</td><td>8</td></tr><tr><td>1</td><td>1</td><td>1</td><td>16</td></tr></tbody></table></li><li><p>ENABLE</p><p>LOW: enable module</p><p>HIGH: disable module</p></li><li><p>SLEEP</p><p>LOW: sleep</p><p>HIGH: active</p></li><li><p>RESET</p><p>LOW: reset module</p></li></ol><h4 id="steps-per-unit" tabindex="-1"><a class="header-anchor" href="#steps-per-unit" aria-hidden="true">#</a> Steps per unit</h4><p>Now we know how to control stepper motor through <code>A4988</code>. But how long does the hotend travel(mm) if motor advance one step?</p><ul><li><p>Synchronized pulleys and belts</p><p>Take the 2GT 20-tooth synchronous wheel as an example. 2GT means that one tooth corresponds 2mm, then if the synchronous wheel has 20 teeth, each time it rotates 1 revolution, the belt will travels 40mm. And if we motor drive as 16 subdivision, then one revolution means 3200 pulses is needed.</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>stepPerUnit = 3200steps / 40mm
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>Screw</p><p>Take a screw with a pitch of 2mm and a lead of 8mm as an example. The lead means the linear distance traveled by the screw for one revolution.</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>stepPerUnit = 3200steps / 8mm
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><h3 id="endstop" tabindex="-1"><a class="header-anchor" href="#endstop" aria-hidden="true">#</a> Endstop</h3><p><img src="/simple-3d-printer/assets/image-20220312064107893.a38e7068.png" alt="image-20220312064107893"></p><p><code>Endstop</code> has 3 pins: normal open(<code>NO</code>), normal close(<code>NC</code>), circuit common(<code>COM</code>). If we the <code>NC</code> and <code>COM</code> then:</p><table><thead><tr><th>State</th><th>on or off</th><th>MCU read</th></tr></thead><tbody><tr><td>not triggered</td><td>on</td><td>LOW</td></tr><tr><td>triggered</td><td>break</td><td>HIGH</td></tr></tbody></table><h3 id="motion-control" tabindex="-1"><a class="header-anchor" href="#motion-control" aria-hidden="true">#</a> Motion control</h3><h4 id="how-to-advance" tabindex="-1"><a class="header-anchor" href="#how-to-advance" aria-hidden="true">#</a> How to advance</h4><p>Assuming that our starting point is (0,0), target point is (6, 3). Then <code>motorX</code> shoud advance (6 x 80) steps, <code>motorY</code> should advance (3 x 80) steps. Of course, we can demand the <code>motorX</code> to advance first then <code>motorY</code> like Plan B. But there is a better way like Plan A.</p><img src="/simple-3d-printer/assets/052B3E34-1BB4-4F72-92F0-9E9F1A33BFCE_1646712370349.845f87c6.jpeg" alt="052B3E34-1BB4-4F72-92F0-9E9F1A33BFCE_1646712370349" style="zoom:57%;"><p>This is <em>Bresenham&#39;s algorithm.</em> Specifically, since it takes 480 steps in the X direction and 240 steps in the Y direction, hotend should move 480 times, each time <code>motorX</code> advance one step, however <code>motorY</code> advance one step each tow times. Each time of motion is called a <code>step event</code>. The total number of times is called <code>step event count</code>, and its value is the greater of X and Y.</p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// module/Planner.cpp - planBufferLine</span>
block<span class="token punctuation">.</span>stepEventCount <span class="token operator">=</span> <span class="token function">getMax</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>steps<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// main.cpp - motion control isr</span>
motorX<span class="token punctuation">.</span>deltaError <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span>curBlock<span class="token operator">-&gt;</span>stepEventCount <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
motorY<span class="token punctuation">.</span>deltaError <span class="token operator">=</span> motorX<span class="token punctuation">.</span>deltaError<span class="token punctuation">;</span>

motorX<span class="token punctuation">.</span>deltaError <span class="token operator">+=</span> curBlock<span class="token operator">-&gt;</span>steps<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>motorX<span class="token punctuation">.</span>deltaError <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    motorX<span class="token punctuation">.</span><span class="token function">moveOneStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    motorX<span class="token punctuation">.</span>deltaError <span class="token operator">-=</span> curBlock<span class="token operator">-&gt;</span>stepEventCount<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

motorY<span class="token punctuation">.</span>deltaError <span class="token operator">+=</span> curBlock<span class="token operator">-&gt;</span>steps<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>motorY<span class="token punctuation">.</span>deltaError <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    motorY<span class="token punctuation">.</span><span class="token function">moveOneStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    motorY<span class="token punctuation">.</span>posInSteps <span class="token operator">+=</span> curBlock<span class="token operator">-&gt;</span>dir<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    motorY<span class="token punctuation">.</span>deltaError <span class="token operator">-=</span> curBlock<span class="token operator">-&gt;</span>stepEventCount<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Do not use <strong>float</strong> to calculate the number of steps directly, because it might lead to step missing.</p><p><img src="/simple-3d-printer/assets/16467305795311.f9f1af10.png" alt="零件失步的原因最终找到了, 居然是浮点数的计算误差"></p><h4 id="multiple-motion-commands" tabindex="-1"><a class="header-anchor" href="#multiple-motion-commands" aria-hidden="true">#</a> Multiple motion commands</h4><p>We should push a <code>block</code> which contains how many steps every motor should advance in a <code>queue</code>, and take it out when needed.</p><ul><li><p><code>block</code></p><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code>block<span class="token punctuation">.</span>dir<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">1</span>
block<span class="token punctuation">.</span>steps<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">37</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
block<span class="token punctuation">.</span>stepEventCount <span class="token operator">=</span> <span class="token number">37</span>
block<span class="token punctuation">.</span>accelerateUntil <span class="token operator">=</span> <span class="token number">6</span>
block<span class="token punctuation">.</span>decelerateAfter <span class="token operator">=</span> <span class="token number">37</span>
block<span class="token punctuation">.</span>entryRate <span class="token operator">=</span> <span class="token number">1808</span>
block<span class="token punctuation">.</span>nominalRate <span class="token operator">=</span> <span class="token number">2001</span>
block<span class="token punctuation">.</span>exitRate <span class="token operator">=</span> <span class="token number">2001</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="speed-control" tabindex="-1"><a class="header-anchor" href="#speed-control" aria-hidden="true">#</a> Speed control</h3><p>For example, if we want set speed as 1000steps/s, then every <code>step event</code> takes 1ms, which means every 1ms an interrupt should be generated.</p><h4 id="trapezoidal-acceleration" tabindex="-1"><a class="header-anchor" href="#trapezoidal-acceleration" aria-hidden="true">#</a> Trapezoidal acceleration</h4><p>We can set speed as constant, but changing the speed can improve efficiency.</p><p>Specifically, a block can be divided into an acceleration segment, a constant speed segment and a deceleration segment. Noted that if the length of block is very short, the acceleration graph should becomes a triangle.</p><p><img src="/simple-3d-printer/assets/9D04FC9D-22CA-49D8-B0CE-71BEA0E9D407_1646716173573-16467162065611.4f3174fe.jpeg" alt="9D04FC9D-22CA-49D8-B0CE-71BEA0E9D407_1646716173573"></p><h4 id="connection-speed" tabindex="-1"><a class="header-anchor" href="#connection-speed" aria-hidden="true">#</a> Connection speed</h4><p>In order to prevent the speed and coherence between each block. We need to calculate the entry speed and exit speed of each block. The estimation method is given below. Noted that the arc in the figure is only used to estimate the connection speed. The hotend does not go through this arc in practice.</p><p><img src="/simple-3d-printer/assets/image-20220312064937037.2bffaea6.png" alt="image-20220312064937037"></p></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: arno756@outlook.com">Arno Solo</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/simple-3d-printer/assets/app.3e33cde9.js" defer></script>
  </body>
</html>
